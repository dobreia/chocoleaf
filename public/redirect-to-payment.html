<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8" />
    <title>Fizetés indítása...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial, sans-serif;
            padding: 24px;
            max-width: 680px;
            margin: auto
        }
    </style>
</head>

<body>
    <h1>Átirányítás Barion fizetésre...</h1>
    <p>Kérlek, várj egy pillanatot.</p>

    <script>
        (async function () {
            try {
                const qp = new URLSearchParams(location.search);
                const bookingUid = qp.get("uid") || qp.get("bookingUid") || qp.get("bookingId");
                const course = qp.get("course");      // csak slug kell
                const name = qp.get("name") || "";
                const email = qp.get("email") || "";
                const startTime = qp.get("startTime") || "";
                const endTime = qp.get("endTime") || "";

                if (!bookingUid) throw new Error("Hiányzik a foglalás azonosító (bookingUid).");
                if (!course) throw new Error("Hiányzik a kurzus azonosító (course).");

                const r = await fetch("/api/barion/start", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ bookingUid, course, name, email, startTime, endTime })
                });

                if (!r.ok) {
                    const t = await r.text();
                    throw new Error("Szerver hiba: " + t);
                }
                const data = await r.json();

                if (data.redirectUrl) {
                    location.replace(data.redirectUrl);
                } else {
                    throw new Error("Nem érkezett redirectUrl a szervertől.");
                }
            } catch (e) {
                alert("Hiba a fizetés indításakor: " + e.message);
                console.error(e);
            }
        })();
    </script>
    <!-- === Szükséges scriptek (nem kell cookie consent) === -->

    <!-- Barion fizetési integráció -->
    <script src="https://api.barion.com/js/barion.js" defer></script>

    <!-- Cal.com időpontfoglaló -->
    <script src="https://cal.com/embed.js" async></script>

    <!-- Saját oldal működése -->
    <script src="/js/main.js" defer></script>

    <!-- Cookie consent manager (később az analitika/marketinghez) -->
    <script src="/js/consent.js" defer></script>

</body>

</html>