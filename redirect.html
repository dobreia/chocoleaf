<script>
    window.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentId = urlParams.get("paymentId");
        const courseId = urlParams.get("course");

        if (!paymentId) {
            window.location.href = "giftcard.html";
            return;
        }

        const POSKey = "d85be135-f5bc-4c84-a8fe-fc3bc55012bb";

        try {
            const response = await fetch(
                "https://api.test.barion.com/v2/Payment/GetPaymentState?POSKey=" + POSKey + "&PaymentId=" + paymentId
            );
            const data = await response.json();

            if (data.Status === "Succeeded") {
                try {
                    const bookingResponse = await fetch("/api/create-booking", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            eventTypeId: "evt_123456",   // Cal.com esemény ID
                            startTime: "2025-09-20T14:00:00Z",
                            endTime: "2025-09-20T15:00:00Z",
                            name: "Teszt Felhasználó",
                            email: "teszt@example.com"
                        })
                    });

                    const bookingData = await bookingResponse.json();
                    if (bookingResponse.ok) {
                        window.location.href = "thankyou.html?course=" + courseId;
                    } else {
                        alert("Fizetés sikerült, de a foglalás nem jött létre: " + bookingData.message);
                    }
                } catch (err) {
                    console.error("Foglalás hiba:", err);
                    alert("Fizetés sikeres, de a foglalás rögzítése nem sikerült.");
                }
            } else {
                // sikertelen vagy megszakított fizetés
                window.location.href = "idopont.html?status=cancelled";
            }
        } catch (err) {
            console.error("Hiba a Barion lekérdezéskor:", err);
            window.location.href = "giftcard.html?status=error";
        }
    });
</script>