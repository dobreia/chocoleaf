<script>
    window.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const paymentId = urlParams.get("paymentId");
        const courseId = urlParams.get("course");

        // Cal.com redirectből jövő adatok
        const name = urlParams.get("name");
        const email = urlParams.get("email");
        const startTime = urlParams.get("startTime");
        const endTime = urlParams.get("endTime");

        if (!paymentId) {
            window.location.href = "giftcard.html";
            return;
        }

        const POSKey = "d85be135-f5bc-4c84-a8fe-fc3bc55012bb";

        // kurzusokhoz tartozó Cal.com eventTypeId-k
        const courses = {
            gyereknapi: { eventTypeId: "evt_abc123" },
            alap: { eventTypeId: "evt_def456" },
            halado: { eventTypeId: "evt_ghi789" },
            muffin: { eventTypeId: "evt_jkl012" },
            elso: { eventTypeId: "evt_mno345" },
            torta: { eventTypeId: "evt_pqr678" }
        };

        const course = courses[courseId];
        if (!course) {
            alert("Ismeretlen kurzus azonosító: " + courseId);
            window.location.href = "idopont.html";
            return;
        }

        try {
            const response = await fetch(
                "https://api.test.barion.com/v2/Payment/GetPaymentState?POSKey=" + POSKey + "&PaymentId=" + paymentId
            );
            const data = await response.json();

            if (data.Status === "Succeeded") {
                try {
                    const bookingResponse = await fetch("https://chocoleaf.vercel.app/api/create-booking", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            eventTypeId: course.eventTypeId,
                            startTime,
                            endTime,
                            name,
                            email
                        })
                    });

                    const bookingData = await bookingResponse.json();
                    if (bookingResponse.ok) {
                        window.location.href = "thankyou.html?course=" + courseId;
                    } else {
                        alert("Fizetés sikerült, de a foglalás nem jött létre: " + bookingData.message);
                    }
                } catch (err) {
                    console.error("Foglalás hiba:", err);
                    alert("Fizetés sikeres, de a foglalás rögzítése nem sikerült.");
                }
            } else {
                window.location.href = "idopont.html?status=cancelled";
            }
        } catch (err) {
            console.error("Hiba a Barion lekérdezéskor:", err);
            window.location.href = "giftcard.html?status=error";
        }
    });
</script>